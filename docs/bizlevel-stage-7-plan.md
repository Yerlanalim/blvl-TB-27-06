# BizLevel - Этап 7: План безопасной оптимизации и улучшений

## Общие принципы этапа
- **Проверка перед удалением**: Каждое удаление должно быть проверено на зависимости
- **Приоритет стабильности**: Лучше оставить неиспользуемый код, чем сломать функционал
- **Фокус на UX улучшениях**: Реализация критических изменений из рекомендаций v1.0
- **Поэтапное тестирование**: После каждой задачи - проверка работоспособности

---

## Фаза 7.1: Критические UX улучшения (2-3 дня)

### Задача 7.1.1: Упрощение Onboarding Flow
**Промпт для Cursor:**
```
Упрости onboarding процесс до 2 шагов согласно рекомендациям v1.0:

1. Анализ текущего flow в src/hooks/use-onboarding-steps.ts:
   - Найди все шаги: USER_DETAILS, INITIAL_QUESTIONS, TIME_COMMITMENT, NOTIFICATIONS, PRICING
   - Проверь зависимости каждого шага через поиск по проекту

2. Безопасное отключение шагов:
   - Закомментируй (НЕ удаляй) шаги: TIME_COMMITMENT, NOTIFICATIONS
   - Оставь только: USER_DETAILS → INTRO_VIDEO (новый шаг)
   
3. Создай новый шаг INTRO_VIDEO:
   - После USER_DETAILS показывай видео с объяснением системы
   - Используй Vimeo видео (https://vimeo.com/263619741)
   - Используй VerticalVideoPlayer компонент если подходит
   - После видео - автоматический переход к первому уроку

4. Обнови src/contexts/onboarding-context.tsx:
   - Упрости state management
   - Добавь проверку на показ видео только для новых пользователей

ВАЖНО: НЕ удаляй код полностью, только отключи через комментарии для возможности отката.
```

**Проверка после выполнения:**
- [ ] Онбординг сокращен до 2 шагов
- [ ] Intro видео показывается новым пользователям
- [ ] Автоматический переход к первому уроку работает
- [ ] Старый код закомментирован, не удален

### Задача 7.1.2: Глобальный индикатор прогресса
**Промпт для Cursor:**
```
Используй существующий компонент прогресса и сделай его глобально видимым:

1. СНАЧАЛА изучи существующий компонент:
   - Найди src/components/app/navigation/level-progress.tsx
   - Проверь что он показывает и как получает данные
   - Если он подходит - используй его, не создавай новый

2. Если level-progress.tsx подходит:
   - Интегрируй его в src/components/app/app-layout.tsx
   - Desktop: под header, перед основным контентом
   - Mobile: сделай компактную версию или скрой если слишком большой

3. Если нужны доработки level-progress.tsx:
   - Добавь показ общего % завершения курса
   - Добавь накопленный XP если его нет
   - Сделай адаптивную версию для мобильных

4. Оптимизация:
   - Проверь что компонент не делает лишних запросов
   - Добавь мемоизацию если нужно
   - Убедись что анимации плавные

ПРИНЦИП: Максимально используй существующий код, минимум новых компонентов
```

**Проверка после выполнения:**
- [ ] Индикатор видим на всех страницах
- [ ] Корректно показывает прогресс
- [ ] Адаптивен для мобильных
- [ ] Не конфликтует с существующими компонентами

### Задача 7.1.3: Мобильная навигация (Bottom Navigation)
**Промпт для Cursor:**
```
Создай bottom navigation bar для мобильных устройств:

1. СНАЧАЛА проверь зависимости:
   - Найди все места использования sidebar в мобильной версии
   - Проверь, не сломается ли функционал при скрытии sidebar

2. Создай src/components/app/mobile-nav/bottom-navigation.tsx:
   - 4 пункта: Главная, Карта, Чат с Лео, Профиль
   - Используй иконки из lucide-react: Home, Map, MessageCircle, User
   - Соответствующие href: /main, /roadmaps, /leo-chat, /profile
   - Активный пункт выделен более ярким цветом
   - Фиксированный внизу экрана

3. Обнови src/components/app/sidebar/sidebar.tsx:
   - Добавь класс hidden на мобильных: className="hidden lg:flex"
   - НЕ удаляй код, только скрой через CSS

4. Интеграция в layout:
   - Добавь bottom navigation в app-layout.tsx
   - Показывай только на мобильных: className="lg:hidden"
   - Убедись что контент не перекрывается навигацией (padding-bottom)

ВАЖНО: Сохрани всю функциональность sidebar для desktop версии
```

**Проверка после выполнения:**
- [ ] Bottom nav появляется только на мобильных
- [ ] Sidebar работает на desktop
- [ ] Навигация между разделами работает
- [ ] Контент не перекрывается навигацией

### Задача 7.1.4: Доступ к пройденным урокам
**Промпт для Cursor:**
```
СНАЧАЛА проверь - возможно доступ к пройденным урокам уже работает:

1. Тестирование существующего функционала:
   - Пройди несколько уроков и попробуй вернуться назад
   - Проверь кнопки "Предыдущий урок" - активны ли они?
   - Если доступ уже есть - пропусти пункты 2-3

2. Если доступа нет, проверь текущую логику навигации:
   - Найди src/utils/data/questions/question-navigation.ts
   - Изучи как работает блокировка prev/next
   - Найди места где проверяется isCompleted

3. Обнови логику навигации (если нужно):
   - Разреши навигацию НАЗАД если урок пройден (isCompleted = true)
   - Сохрани блокировку ВПЕРЕД для непройденных уроков
   - Добавь визуальную индикацию: ✓ для пройденных

4. Создай страницу "Мои уроки" src/app/(app)/my-lessons/page.tsx:
   - Список всех пройденных уроков группированный по уровням
   - Для каждого: название, дата прохождения, результат теста
   - Возможность перейти к любому пройденному уроку
   - Фильтр: все/видео/тесты

5. Добавь пункт в навигацию (если страница создана):
   - Desktop: в sidebar после "Карта уровней"
   - Mobile: можно объединить с "Карта" через табы

ВАЖНО: Сначала проверь что уже работает, не создавай дубли функционала
```

**Проверка после выполнения:**
- [ ] Можно вернуться к пройденным урокам
- [ ] Нельзя перейти к будущим урокам
- [ ] Страница "Мои уроки" работает
- [ ] Визуальные индикаторы ✓ показываются

---

## Фаза 7.2: Engagement улучшения (2 дня)

### Задача 7.2.1: Welcome Email
**Промпт для Cursor:**
```
Настрой отправку welcome email при регистрации:

1. Проверь существующий шаблон:
   - Открой src/components/emails/welcome.tsx
   - Убедись что контент соответствует бизнес-тематике
   - Обнови если нужно: приветствие, 3 шага старта, ссылка на урок 1

2. Найди место регистрации:
   - src/app/(no_nav)/(auth)/signup/page.tsx
   - Найди где происходит создание пользователя

3. Добавь отправку email после успешной регистрации:
   - Используй существующую систему отправки (проверь как отправляются другие email)
   - Передай имя пользователя и email
   - Добавь try/catch чтобы ошибка email не блокировала регистрацию

4. Проверь Supabase Edge Functions:
   - Если используются для email - проверь что функция активна
   - Если нет - используй API route для отправки

ВАЖНО: Email не должен блокировать процесс регистрации
```

**Проверка после выполнения:**
- [ ] Email отправляется новым пользователям
- [ ] Содержание соответствует бизнес-тематике
- [ ] Ошибка отправки не блокирует регистрацию
- [ ] Ссылки в email работают

### Задача 7.2.2: Подсказки при неправильных ответах
**Промпт для Cursor:**
```
Улучши UX при неправильных ответах в тестах:

1. Найди компонент обработки ответов:
   - src/components/app/questions/answer-submitted.tsx
   - Изучи текущую логику показа результата

2. Обнови сообщения об ошибке:
   - Замени "Неправильно!" на "Попробуйте еще раз 💪"
   - Добавь мотивационные фразы: "Вы на правильном пути!"
   
3. Реализуй систему подсказок:
   - После 1 попытки: показывай hint из БД (если есть)
   - После 2 попытки: показывай кнопку "Спросить Leo"
   - После 3 попытки: показывай правильный ответ с объяснением

4. Проверь поле hint в Questions:
   - Если поле есть - используй его
   - Если нет - добавь заглушку "Подумайте еще раз"

5. Интеграция с Leo:
   - Кнопка "Спросить Leo" должна открывать чат с контекстом вопроса
   - Leo должен давать подсказку, не раскрывая ответ полностью

ПРОВЕРЬ: Сохраняется ли количество попыток в БД
```

**Проверка после выполнения:**
- [ ] Позитивные сообщения вместо негативных
- [ ] Подсказки показываются поэтапно
- [ ] Интеграция с Leo работает
- [ ] Hint из БД используется если есть

### Задача 7.2.3: Улучшение видимости Leo AI
**Промпт для Cursor:**
```
Сделай Leo AI более заметным и полезным:

1. Найди кнопку Leo чата:
   - Должна быть в правом нижнем углу
   - Проверь z-index и видимость на всех страницах

2. Добавь анимированную подсказку для новых пользователей:
   - При первом входе: пульсация кнопки Leo
   - Tooltip: "Привет! Я Leo, ваш помощник. Задайте любой вопрос!"
   - Сохрани в localStorage что подсказка показана

3. Проактивные сообщения от Leo:
   - При неправильном ответе 2 раза: "Нужна помощь с этим вопросом?"
   - При завершении уровня: "Поздравляю! Готовы обсудить следующий уровень?"
   - При долгом бездействии (5 мин): "Застряли? Я могу помочь!"

4. Обнови счетчик сообщений:
   - Показывай лимит: "Осталось 25 из 30 сообщений" для FREE
   - Для PREMIUM: "30 сообщений в день"
   - Стилизуй красиво под основной дизайн

5. Быстрые кнопки в чате:
   - "Объясни текущий урок"
   - "Дай пример из реальной жизни"  
   - "Что дальше изучать?"

ВАЖНО: Не делай Leo навязчивым, только полезные подсказки
```

**Проверка после выполнения:**
- [ ] Кнопка Leo всегда видна
- [ ] Анимация привлекает внимание новичков
- [ ] Проактивные сообщения работают
- [ ] Счетчик лимита отображается

---

## Фаза 7.3: Безопасная техническая очистка (2 дня)

### Задача 7.3.1: Проверка и удаление технических иконок
**Промпт для Cursor:**
```
Безопасно удали неиспользуемые технические иконки:

1. СНАЧАЛА найди все использования каждой иконки:
   ```bash
   grep -r "javascript\.tsx\|typescript\.tsx\|react\.tsx\|html\.tsx\|css\.tsx" src/
   grep -r "JavaScriptIcon\|TypeScriptIcon\|ReactIcon\|HtmlIcon\|CssIcon" src/
   ```

2. Для каждой неиспользуемой иконки:
   - Проверь импорты в components и pages
   - Проверь lazy imports и dynamic imports
   - Проверь storybook stories

3. Если иконка точно не используется:
   - Удали файл из src/components/ui/icons/
   - Проверь что проект компилируется: npm run build

4. НЕ УДАЛЯЙ если есть сомнения в использовании

5. Создай список удаленных файлов в docs/cleanup-log.md

РЕЗУЛЬТАТ: ~12KB экономии размера bundle
```

**Проверка после выполнения:**
- [ ] Удалены только неиспользуемые иконки
- [ ] Проект успешно компилируется
- [ ] Нет ошибок в runtime
- [ ] Документирован список изменений

### Задача 7.3.2: Замена coding-facts на business-facts
**Промпт для Cursor:**
```
Замени технические факты на бизнес-факты:

1. Найди файл src/utils/constants/coding-facts.ts

2. ПРОВЕРЬ использование:
   - Где импортируется этот файл?
   - Какие компоненты используют эти факты?

3. Создай новый файл src/utils/constants/business-facts.ts:
   - Минимум 20 интересных фактов о бизнесе
   - Формат такой же как в coding-facts
   - Примеры: "80% стартапов проваливаются в первые 3 года"

4. Замени импорты во всех найденных местах:
   - from './coding-facts' → from './business-facts'
   - Проверь что компоненты работают

5. Только после проверки - удали coding-facts.ts

ВАЖНО: Сохрани структуру данных для совместимости
```

**Проверка после выполнения:**
- [ ] Новый файл business-facts.ts создан
- [ ] Все импорты обновлены
- [ ] Факты отображаются корректно
- [ ] Старый файл удален

### Задача 7.3.3: Очистка последних упоминаний TechBlitz
**Промпт для Cursor:**
```
Удали последние 3 упоминания TechBlitz:

1. В src/app/(app)/(default_layout)/statistics/page.tsx:
   - Найди строку с @techblitz.dev (около строки 59)
   - Удали проверку: || user.email?.endsWith('@techblitz.dev')
   - Оставь только: user.email?.endsWith('@bizlevel.kz')

2. В prisma/seed-bizlevel-level1.ts:
   - Найди функцию cleanupTechBlitzData (строка ~227)
   - Переименуй в cleanupLegacyData
   - Обнови комментарий: "Очистка устаревших данных"

3. В scripts/cleanup-techblitz-data.sql:
   - Переименуй файл в cleanup-legacy-data.sql
   - Обнови комментарии внутри файла

4. Финальная проверка:
   ```bash
   grep -r "techblitz\|TechBlitz" src/ --exclude-dir=node_modules
   ```

РЕЗУЛЬТАТ: Полная очистка бренда TechBlitz
```

**Проверка после выполнения:**
- [ ] @techblitz.dev удален из админ проверки
- [ ] Функция переименована
- [ ] SQL скрипт переименован
- [ ] grep не находит упоминаний

### Задача 7.3.4: Настройка lazy loading для Monaco Editor
**Промпт для Cursor:**
```
Настрой lazy loading для Monaco Editor вместо удаления:

1. КРИТИЧНО: НЕ удаляй Monaco из package.json!

2. Найди все импорты Monaco:
   ```bash
   grep -r "@monaco-editor\|MonacoEditor" src/
   ```

3. Для каждого найденного компонента с Monaco:
   - Конвертируй в dynamic import с Next.js
   - Пример:
   ```typescript
   const MonacoEditor = dynamic(
     () => import('@monaco-editor/react'),
     { 
       ssr: false,
       loading: () => <div>Загрузка редактора...</div>
     }
   );
   ```

4. Проверь что Monaco загружается только когда нужен:
   - Должен загружаться только для CODING_CHALLENGE типа
   - Не должен загружаться для VIDEO и MULTIPLE_CHOICE

5. Измерь улучшение:
   - Запусти npm run analyze
   - Monaco должен быть в отдельном chunk

ВАЖНО: Сохрани функциональность для будущего использования
```

**Проверка после выполнения:**
- [ ] Monaco загружается только когда нужен
- [ ] Основной bundle уменьшился
- [ ] CODING_CHALLENGE тип все еще работает
- [ ] Отдельный chunk для Monaco создан

---

## Фаза 7.4: Оптимизация кода (1 день)

### Задача 7.4.1: Централизация логики навигации
**Промпт для Cursor:**
```
Создай централизованный хук для навигации между вопросами:

1. Анализ дублирования:
   - Найди похожую логику в:
     - src/components/app/navigation/question-navigation.tsx
     - src/components/app/roadmaps/questions/question-card.tsx
     - src/components/app/study-paths/study-path-question-card.tsx

2. Создай src/hooks/use-question-navigation.ts:
   ```typescript
   export const useQuestionNavigation = (
     questionId: string, 
     pathType: 'study' | 'roadmap' | 'single'
   ) => {
     // Централизованная логика
     return {
       nextQuestion,
       prevQuestion,
       progress,
       canGoNext,
       canGoPrev,
       handleAnswer,
       isLoading
     }
   }
   ```

3. Рефакторинг компонентов:
   - Замени дублированную логику на использование хука
   - Сохрани специфичную логику каждого компонента
   - НЕ ломай существующий функционал

4. Тестирование:
   - Проверь навигацию в study paths
   - Проверь навигацию в roadmaps
   - Проверь single question navigation

ВАЖНО: Это сложный рефакторинг, делай постепенно
```

**Проверка после выполнения:**
- [ ] Хук создан и работает
- [ ] Дублирование кода уменьшено
- [ ] Вся навигация работает как раньше
- [ ] Код стал читабельнее

### Задача 7.4.2: TypeScript строгость - удаление any
**Промпт для Cursor:**
```
Исправь небезопасные any типы в Questions:

1. Найди в src/types/Questions.ts:
   - testCases: any
   - expectedParams: any

2. СНАЧАЛА проверь использование:
   - Где используются эти поля?
   - Какие данные там хранятся?
   - Есть ли миграции БД с примерами?

3. Создай правильные типы:
   ```typescript
   interface TestCase {
     input: string;
     expectedOutput: string;
     isHidden?: boolean;
   }
   
   interface ParamConfig {
     name: string;
     type: 'string' | 'number' | 'boolean';
     required: boolean;
   }
   
   // В Question type:
   testCases: TestCase[] | null;
   expectedParams: ParamConfig[] | null;
   ```

4. Обнови все места использования:
   - Добавь проверки на null
   - Исправь TypeScript ошибки
   - НЕ меняй логику, только типы

5. Проверь что все компилируется

ВАЖНО: Эти поля могут быть null для VIDEO типа
```

**Проверка после выполнения:**
- [ ] any типы заменены на строгие
- [ ] TypeScript ошибок нет
- [ ] Логика не изменилась
- [ ] Учтены nullable поля

---

## Фаза 7.5: Финальный анализ и отчет (1 день)

### Задача 7.5.1: Комплексный анализ кодовой базы
**Промпт для Cursor:**
```
Проведи финальный анализ проекта после всех изменений:

1. Запусти Knip анализ:
   ```bash
   pnpm run knip > docs/final-knip-report.md
   ```
   - Проанализируй неиспользуемые файлы
   - Проверь неиспользуемые зависимости
   - Найди неиспользуемые экспорты

2. Используй Code Analysis MCP для детального анализа:
   - Архитектура и структура проекта
   - Качество кода и TypeScript покрытие
   - Дублирование и технический долг
   - Performance метрики

3. Анализ tree shaking и bundle:
   ```bash
   # Сначала создай production build
   npm run build
   
   # Запусти bundle analyzer
   ANALYZE=true npm run build
   
   # Проверь tree shaking эффективность
   npx webpack-bundle-analyzer .next/analyze/client.html
   ```

4. Проверь ключевые метрики:
   - Bundle size основных страниц (должен быть < 400KB)
   - Количество chunks и их размеры
   - Неиспользуемый код в bundle
   - Эффективность code splitting

5. Создай финальный отчет docs/stage-7-final-report.md:
   ```markdown
   # Финальный отчет Этапа 7
   
   ## Executive Summary
   - Общее состояние проекта
   - Ключевые достижения
   - Оставшиеся проблемы
   
   ## Метрики до и после
   - Bundle size
   - TypeScript coverage
   - Количество файлов
   - Performance score
   
   ## Knip Analysis
   - Неиспользуемые файлы: X
   - Неиспользуемые зависимости: Y
   - Потенциальная экономия: Z KB
   
   ## Code Quality
   - Дублированный код: X%
   - TypeScript строгость: Y%
   - Консольные ошибки: 0
   
   ## Tree Shaking Results
   - Эффективность: X%
   - Неиспользуемый код в bundle: Y KB
   - Рекомендации по улучшению
   
   ## Рекомендации для v2.0
   - Что можно улучшить
   - Что отложено на потом
   - Потенциальные риски
   ```

ВАЖНО: Этот анализ - основа для принятия решения о готовности к запуску
```

**Проверка после выполнения:**
- [ ] Все анализы выполнены
- [ ] Метрики задокументированы
- [ ] Отчет создан и структурирован
- [ ] Рекомендации сформулированы

---

## Метрики успеха Этапа 7

### User Experience
- [ ] Onboarding completion: 27% → 50%+ 
- [ ] Время до первого урока: < 3 минуты
- [ ] Mobile usability score: 90%+
- [ ] Leo AI engagement: 40%+ пользователей

### Технические метрики
- [ ] Bundle size: уменьшение на 5-10%
- [ ] TypeScript coverage: 95%+
- [ ] Дублированный код: -30%
- [ ] Консольные ошибки: 0

### Готовность к запуску
- [ ] Критические UX улучшения: 100%
- [ ] Безопасная очистка: 100%
- [ ] Документация изменений: 100%
- [ ] Откат возможен для каждого изменения

---

## Важные напоминания

1. **Перед каждым удалением** - проверяй зависимости через grep
2. **Комментируй, не удаляй** - если есть сомнения
3. **Тестируй после каждой задачи** - npm run build минимум
4. **Документируй изменения** - в docs/cleanup-log.md
5. **Приоритет стабильности** - лучше оставить лишнее, чем сломать

После завершения Этапа 7 проект будет готов к production запуску с улучшенным UX и оптимизированным кодом.